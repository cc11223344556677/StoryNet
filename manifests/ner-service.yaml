apiVersion: apps/v1
kind: Deployment
metadata:
  name: ner-service
  namespace: app
  labels:
    app: ner-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ner-service
  template:
    metadata:
      labels:
        app: ner-service
    spec:
      containers:
        - name: ner-service
          image: ner-service:latest
          imagePullPolicy: Never
          ports:
            - containerPort: 5000
          resources:
            requests:
              memory: "8Gi"
              cpu: "2"
            limits:
              memory: "16Gi"
              cpu: "4"
          livenessProbe:
            httpGet:
              path: /healthz
              port: 5000
            initialDelaySeconds: 30
            periodSeconds: 15
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /healthz
              port: 5000
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 3
          env:
            # Override the model at deploy time without rebuilding the image.
            # The model must still be baked into the image via the Dockerfile ARG.
            - name: MODEL_NAME
              value: "qwen2.5:7b-instruct-q4_K_M"

---
apiVersion: v1
kind: Service
metadata:
  name: ner-service
  namespace: app
spec:
  selector:
    app: ner-service
  ports:
    - protocol: TCP
      port: 5000
      targetPort: 5000
  type: ClusterIP

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ner-service-ingress
  namespace: app
spec:
  podSelector:
    matchLabels:
      app: ner-service
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: backend   
      ports:
        - protocol: TCP
          port: 5000